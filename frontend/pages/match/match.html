<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Football Matches & Teams</title>
  <link rel="stylesheet" href="../../style/styles_match.css">
</head>
<body>
  <header class="site-header">
    <nav class="main-nav">
        <h1 id="site-title">Stadium Hub</h1>
        <div class="nav-right">
            <button class="user-profile" id="user-profile">User Profile</button>
        </div>
    </nav>
</header>

  <main class="main-content">
    <!-- Teams Section -->
    <section class="teams-section">
      <h2 class="section-title" id="section-title">Select Team</h2>
      <div class="search-box">
        <input type="text" id="team-search" placeholder="Search teams..." aria-label="Search teams">
      </div>
      <div id="teams-container" class="teams-grid" data-loaded="false">
        <div class="loading-spinner">Loading teams...</div>
      </div>
    </section>

    <!-- Matches Section -->
    <section class="matches-section">
      <h2 class="section-title">Upcoming Matches</h2>
      <div class="filter-controls">
        <button class="btn-filter active" data-filter="all">All Matches</button>
        <button id="refresh-btn" class="btn-refresh">Refresh</button>
      </div>
      <div id="matches-container" class="matches-list">
        <div class="loading-spinner">Loading matches...</div>
      </div>
      <div class="pagination">
        <button id="prev-page" class="btn-page" disabled>← Previous</button>
        <span id="page-info" class="page-info">Page 1</span>
        <button id="next-page" class="btn-page">Next →</button>
      </div>
    </section>
  </main>

  <script>
        // DOM Elements
          const siteTitleEl = document.getElementById('site-title');
          const teamSearchEl = document.getElementById('team-search');
          const teamsContainerEl = document.getElementById('teams-container');
          const matchesContainerEl = document.getElementById('matches-container');
          const refreshBtn = document.getElementById('refresh-btn');
          const prevPageBtn = document.getElementById('prev-page');
          const nextPageBtn = document.getElementById('next-page');
          const pageInfoEl = document.getElementById('page-info');
          const profile = document.getElementById('user-profile');
          const selectedTeamEl = document.getElementById('section-title');

          // State
        let currentPage = 1;
        let selectedTeamId = null;
        let allTeams = [];
        let lastFetchedCount = 0; 

          const API_BASE = 'https://stadiumhub.onrender.com/api/v1';

         // Fetch Teams (using XMLHttpRequest)
        function fetchTeams() {
          teamsContainerEl.innerHTML = `<div class="loading-spinner">Loading teams...</div>`;

          const xhr = new XMLHttpRequest();
          xhr.open("GET", `${API_BASE}/team/`, true);
          xhr.withCredentials = true; // เทียบเท่ากับ credentials: "include"

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) { 
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  const data = JSON.parse(xhr.responseText);
                  console.log("Teams data:", data);

                  allTeams = data.data || [];
                  displayTeams(allTeams);
                  teamsContainerEl.setAttribute("data-loaded", "true");
                } catch (err) {
                  console.error("JSON parse error:", err);
                  teamsContainerEl.innerHTML = `<p class="error-message">Invalid server response</p>`;
                }
              } else {
                console.error("Error fetching teams:", xhr.status, xhr.responseText);
                teamsContainerEl.innerHTML = `<p class="error-message">Failed to load teams: HTTP ${xhr.status}</p>`;
              }
            }
          };

          xhr.onerror = function () {
            teamsContainerEl.innerHTML = `<p class="error-message">Network error occurred</p>`;
          };

          xhr.send();
        }


          ///Fetch Matches
          async function fetchMatches(page = 1, teamId = null) {
            try {
              matchesContainerEl.innerHTML = `<div class="loading-spinner">Loading matches...</div>`;
              
              // ใช้ page ตรงๆ ไม่ต้องแปลง (ให้ API จัดการเอง)
              let url;
              if (teamId !== null && teamId !== undefined) {
                url = `${API_BASE}/matches/team/${teamId}?page=${page}&page_size=10&sort=utc_date&order=asc`;
              } else {
                url = `${API_BASE}/matches/?page=${page}&page_size=10&sort=utc_date&order=asc`;
              }
              
              console.log('Fetching matches from:', url);

              const res = await fetch(url, {
                method: "GET",
                credentials: "include"
              });

              if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text}`);
              }

              const data = await res.json();
              console.log('Matches data:', data);

              // รองรับหลายรูปแบบ response
              let matches = [];
              if (Array.isArray(data)) {
                matches = data;
              } else if (data.data) {
                matches = Array.isArray(data.data) ? data.data : (data.data.matches || []);
              }

              // ถ้าไม่มีข้อมูลและไม่ใช่หน้าแรก ให้กลับไปหน้าเดิม
              if (matches.length === 0 && page > 1) {
                console.warn('No data on page', page, '- staying on previous page');
                matchesContainerEl.innerHTML = `<div class="no-data">No more matches available</div>`;
                setTimeout(() => {
                  fetchMatches(page - 1, teamId);
                }, 1000);
                return;
              }

              lastFetchedCount = matches.length;

              console.log('Matches count:', matches.length);
              displayMatches(matches);
              updatePagination(page);
            } catch (err) {
              console.error('Error fetching matches:', err);
              matchesContainerEl.innerHTML = `<p class="error-message">Failed to load matches: ${err.message}</p>`;
              
              // ถ้า error และไม่ใช่หน้าแรก ให้กลับไปหน้าเดิม
              if (page > 1) {
                setTimeout(() => {
                  fetchMatches(page - 1, teamId);
                }, 1500);
              }
            }
          }

          //Display Teams
          function displayTeams(teams) {
            if (!teams || teams.length === 0) {
              teamsContainerEl.innerHTML = `<div class="no-data">No teams found</div>`;
              return;
            }

            teamsContainerEl.innerHTML = '';
            teams.forEach(team => {
              const card = document.createElement('div');
              card.className = 'team-card';
              card.onclick = () => selectTeam(team.ID, team.Name, card);
              card.innerHTML = `
                <div class="team-name">${team.Name || 'Unknown'}</div>
              `;
              teamsContainerEl.appendChild(card);
            });
          }

          //Display Matches
          function displayMatches(matches) {
            if (!matches || matches.length === 0) {
              matchesContainerEl.innerHTML = `<div class="no-data">No matches found</div>`;
              return;
            }

            matchesContainerEl.innerHTML = '';
            matches.forEach(match => {
              const dateString = (match.UTCDate || match.utc_date || match.date).replace('Z', '');
              const date = new Date(dateString);
              const formattedDate = date.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
              const formattedTime = date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
              });

              const status = (match.Status || 'SCHEDULED').toUpperCase();
              const isFinished = status === 'FINISHED';

              const isInPlay = status === 'IN_PLAY' || status === 'LIVE';

              const card = document.createElement('article');
              card.className = 'match-card';
              card.setAttribute('data-status', status);
        
              if (isFinished) {
                card.classList.add('disabled');
              }

              if (isInPlay) {
                card.classList.add('disabled');
              }

              card.innerHTML = `
                <div class="match-date">
                    ${formattedDate}<br>
                    <span class="match-time">${formattedTime}</span>
                </div>
                <div class="match-teams">
                    <div class="team home-team">
                        <span class="team-badge-small">${match.HomeTeam?.TLA || '-'}</span>
                        <span class="team-name-small">${match.HomeTeam?.ShortName || 'Unknown'}</span>
                    </div>
                    <div class="match-vs">VS</div>
                    <div class="team away-team">
                        <span class="team-badge-small">${match.AwayTeam?.TLA || '-'}</span>
                        <span class="team-name-small">${match.AwayTeam?.ShortName || 'Unknown'}</span>
                    </div>
                </div>
                <div class="match-venue">${match.Venue || 'TBA'}</div>
                <div class="match-status status-${status.toLowerCase()}">
                    ${status}
                </div>
              `;
              
              if (!isFinished) {
                card.onclick = () => {
                  const homeTeamId = match.HomeTeam?.ID;
                  const matchId = match.ID;
                  window.location.href = `../booking/booking.html?match_id=${matchId}&team_id=${homeTeamId}`;
                };
              }

              matchesContainerEl.appendChild(card);
            });
          }


          // Select Team
          function selectTeam(teamId, teamName, element) {
            document.querySelectorAll('.team-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            selectedTeamId = teamId;
            selectedTeamEl.textContent = `${teamName} Matches`;
            currentPage = 1; // Reset page
            fetchMatches(1, teamId);
          }

          // ตรวจสอบสถานะการ login ของผู้ใช้
          async function checkLoginStatus() {
            try {
              const res = await fetch(`${API_BASE}/user/profile`, {
                method: 'GET',
                credentials: 'include'
              });

              if (!res.ok) {
                showLoginButton();
                return;
              }

              const data = await res.json();
              if (data && data.data) {
                showProfileAndLogout(data.data);
              } else {
                showLoginButton();
              }
            } catch (err) {
              console.error('Error checking login status:', err);
              showLoginButton();
            }
          }

          // แสดงปุ่ม Login
          function showLoginButton() {
            const navRight = document.querySelector('.nav-right');
            navRight.innerHTML = `
              <button id="login-btn" class="user-login">Login</button>
            `;
            document.getElementById('login-btn').addEventListener('click', () => {
              window.location.href = '../user/login.html';
            });
          }

          // แสดงปุ่ม Profile + Logout
          function showProfileAndLogout(user) {
            const navRight = document.querySelector('.nav-right');
            navRight.innerHTML = `
              <button id="user-profile" class="user-profile">Hello, ${user.username || 'User'}</button>
              <button id="logout-btn" class="user-logout">Logout</button>
            `;

            document.getElementById('user-profile').addEventListener('click', () => {
              window.location.href = '../user/profile.html';
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
              try {
                const res = await fetch(`${API_BASE}/user/logout`, {
                  method: 'POST',
                  credentials: 'include'
                });
                if (res.ok) {
                  alert('Logged out successfully!');
                  showLoginButton();
                } else {
                  alert('Failed to logout');
                }
              } catch (err) {
                console.error('Logout error:', err);
                alert('Error logging out');
              }
            });
          }



          //Pagination
          function updatePagination(page) {
            currentPage = page;
            pageInfoEl.textContent = `Page ${page}`;

            prevPageBtn.disabled = page <= 1;

            nextPageBtn.disabled = lastFetchedCount < 10;
          }

          //Search Teams
          teamSearchEl.addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            
            if (!term) {
              displayTeams(allTeams);
              return;
            }
            
            const filtered = allTeams.filter(t =>
              (t.Name || '').toLowerCase().includes(term) ||
              (t.ShortName || '').toLowerCase().includes(term) ||
              (t.TLA || '').toLowerCase().includes(term)
            );
            displayTeams(filtered);
          });

          //Pagination controls
          prevPageBtn.addEventListener('click', () => {
              if (currentPage > 1) {
                fetchMatches(currentPage - 1, selectedTeamId);
              }
            });

          nextPageBtn.addEventListener('click', () => {
              if (lastFetchedCount >= 10) {
                fetchMatches(currentPage + 1, selectedTeamId);
              }
            });
          refreshBtn.addEventListener('click', async function () {
            this.classList.add('spinning');
            try {
              await fetchMatches(currentPage, selectedTeamId);
            } finally {
              setTimeout(() => this.classList.remove('spinning'), 500);
            }
          });

          // Filter (All / Today)
          document.querySelectorAll('.btn-filter').forEach(btn => {
            btn.addEventListener('click', function () {
              document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
              this.classList.add('active');
              
              const filter = this.dataset.filter;
              if (filter === 'today') {
                filterTodayMatches();
              } else if (filter === 'all') {
                selectedTeamId = null;
                document.querySelectorAll('.team-card').forEach(c => c.classList.remove('selected'));
                selectedTeamEl.textContent = 'Select Team';
                currentPage = 1; 
                fetchMatches(currentPage, null); 
              }
            });
          });

          profile.addEventListener('click', () => {
            window.location.href = '../user/profile.html';
          });

          //Initialize
          document.addEventListener('DOMContentLoaded', () => {
            fetchTeams();
            fetchMatches(1);
            checkLoginStatus();
          });
  </script>
</body>
</html>