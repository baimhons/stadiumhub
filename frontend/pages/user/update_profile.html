<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Update Profile</title>
  <link rel="stylesheet" href="../../style/update_profile.css" />
</head>
<body>
  <div class="card">
    <h1>Edit User Information</h1>
    <div id="status" class="muted">Loading profile...</div>

    <form id="form" novalidate>
      <div class="row">
        <label>Username</label>
        <input id="username" type="text" placeholder="e.g. john_doe" />
      </div>

      <div class="grid2">
        <div class="row">
          <label>First Name</label>
          <input id="first_name" type="text" placeholder="e.g. John" />
        </div>
        <div class="row">
          <label>Last Name</label>
          <input id="last_name" type="text" placeholder="e.g. Smith" />
        </div>
      </div>

      <div class="row">
        <label>Email</label>
        <input id="email" type="email" placeholder="example@domain.com" />
      </div>

      <div class="row">
        <label>Phone Number</label>
        <input id="phone_number" type="tel" placeholder="0812345678" />
        <div class="hint">Enter only 9–10 digits</div>
      </div>

      <div class="actions">
        <button type="submit">Save</button>
        <button type="button" class="secondary" id="cancelBtn">Cancel</button>
      </div>
    </form>
  </div>

  <script>
    const API_BASE = 'https://stadiumhub.onrender.com/api/v1';
    const statusEl = document.getElementById('status');
    const formEl = document.getElementById('form');
    const cancelBtn = document.getElementById('cancelBtn');

    const $ = (id) => document.getElementById(id);

    function qs(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function setStatus(type, msg, extra) {
      statusEl.className = type;
      statusEl.textContent = extra ? `${msg}\n${extra}` : msg;
    }

    function sanitizePhone(p) {
      return (p || '').replace(/\D/g, '').slice(0, 10);
    }

    function validate(values) {
      const errs = [];
      if (!values.username.trim()) errs.push('Username is required');
      if (values.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(values.email)) errs.push('Invalid email');
      if (values.phone_number) {
        const phone = sanitizePhone(values.phone_number);
        if (phone.length < 9 || phone.length > 10) errs.push('Phone number must be 9–10 digits');
      }
      return errs;
    }

    function fillForm(data) {
      $('username').value = data.username || '';
      $('first_name').value = data.first_name || '';
      $('last_name').value = data.last_name || '';
      $('email').value = data.email || '';
      $('phone_number').value = data.phone_number || '';
    }

    async function preload() {
      setStatus('muted', 'Loading profile...');
      try {
        const res = await fetch(`${API_BASE}/user/profile`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        const text = await res.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch {}
        if (!res.ok) {
          setStatus('error', `Failed to load profile (${res.status})`, text);
          return;
        }
        const data = json?.data || json || {};
        fillForm(data);
        setStatus('muted', ''); // ลบข้อความ "Edit information and click Save"
      } catch (err) {
        setStatus('error', 'Failed to load profile', err.message);
      }
    }

    async function updateUser(values) {
      const methods = ['PUT', 'POST'];
      for (let method of methods) {
        try {
          const res = await fetch(`${API_BASE}/user/update`, {
            method,
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(values)
          });
          const text = await res.text();
          let json = null;
          try { json = text ? JSON.parse(text) : null; } catch {}
          if (res.ok) return { ok: true, data: json || text, method };
          if ([404, 405].includes(res.status)) continue;
          return { ok: false, error: `HTTP ${res.status}`, detail: text };
        } catch (e) {
          if (method === 'PUT') continue;
          return { ok: false, error: e.message };
        }
      }
      return { ok: false, error: 'Both PUT and POST failed' };
    }

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('muted', 'Saving...');
      const values = {
        username: $('username').value.trim(),
        first_name: $('first_name').value.trim(),
        last_name: $('last_name').value.trim(),
        email: $('email').value.trim(),
        phone_number: sanitizePhone($('phone_number').value)
      };

      const errs = validate(values);
      if (errs.length) {
        setStatus('error', 'Invalid input:\n' + errs.join('\n'));
        return;
      }

      const result = await updateUser(values);
      if (result.ok) {
        setStatus('ok', 'Saved successfully');
        const ret = qs('return');
        setTimeout(() => {
          location.href = ret || 'profile.html';
        }, 700);
      } else {
        setStatus('error', 'Save failed: ' + (result.error || 'Unknown'), result.detail);
      }
    });

    cancelBtn.addEventListener('click', () => {
      const ret = qs('return');
      if (ret) window.location.href = ret;
      else history.back();
    });

    preload();
  </script>
</body>
</html>
