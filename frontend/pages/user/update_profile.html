<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Update Profile</title>
  <link rel="stylesheet" href="../../style/update_profile.css" />
</head>
<body>
  <div class="card">
    <h1>Edit User Information</h1>
    <div id="status" class="muted">Loading profile...</div>

    <form id="form" novalidate>
      <div class="row">
        <label for="username">Username</label>
        <input
          id="username"
          name="username"
          type="text"
          placeholder="Jamelnwza007"
          autocomplete="username"
          required
          minlength="3"
          pattern="[A-Za-z0-9]{3,20}"
          title="Letters and numbers only (3-20 characters)"
        />
      </div>

      <div class="grid2">
        <div class="row">
          <label for="first_name">First Name</label>
          <input
            id="first_name"
            name="first_name"
            type="text"
            placeholder="John"
            autocomplete="given-name"
            pattern="[A-Za-z]{2,50}"
            title="Letters only (2–50 characters)"
          />
        </div>
        <div class="row">
          <label for="last_name">Last Name</label>
          <input
            id="last_name"
            name="last_name"
            type="text"
            placeholder="Doe"
            autocomplete="family-name"
            pattern="[A-Za-z]{2,50}"
            title="Letters only (2–50 characters)"
          />
        </div>
      </div>

      <div class="row">
        <label for="email">Email</label>
        <input
          id="email"
          name="email"
          type="email"
          placeholder="you1234@example.com"
          autocomplete="email"
          title="Enter a valid email address"
        />
      </div>

      <div class="row">
        <label for="phone_number">Phone Number</label>
        <input
          id="phone_number"
          name="phone_number"
          type="tel"
          inputmode="numeric"
          autocomplete="tel"
          placeholder="0123456789"
          pattern="[0-9]{9,15}"
          title="Digits only (9-15 numbers)"
          maxlength="15"
        />
        <div class="hint">Numbers only, 9–15 digits</div>
      </div>

      <div class="actions">
        <button type="submit">Save</button>
        <button type="button" class="secondary" id="cancelBtn">Cancel</button>
      </div>
    </form>
  </div>

  <script>
    const API_BASE = 'https://stadiumhub.onrender.com/api/v1';
    const statusEl = document.getElementById('status');
    const formEl = document.getElementById('form');
    const cancelBtn = document.getElementById('cancelBtn');
    const $ = (id) => document.getElementById(id);

    function qs(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function setStatus(type, msg, extra) {
      statusEl.className = type;
      statusEl.textContent = extra ? `${msg}\n${extra}` : msg;
    }

    function sanitizePhone(p) {
      return (p || '').replace(/\D/g, '').slice(0, 15);
    }

    function validate(values) {
      const errs = [];
      if (!values.username.trim()) errs.push('Username is required');

      if (values.username && !/^[A-Za-z0-9]{3,20}$/.test(values.username)) {
        errs.push('Username: letters and numbers only (3-20)');
      }

      if (values.first_name && !/^[A-Za-z]{2,50}$/.test(values.first_name)) {
        errs.push('First name: letters only (2–50)');
      }
      if (values.last_name && !/^[A-Za-z]{2,50}$/.test(values.last_name)) {
        errs.push('Last name: letters only (2–50)');
      }

      if (values.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(values.email)) {
        errs.push('Invalid email');
      }

      if (values.phone_number) {
        const phone = sanitizePhone(values.phone_number);
        if (!/^\d{9,15}$/.test(phone)) {
          errs.push('Phone number must be digits only (9–15)');
        }
      }
      return errs;
    }

    function fillForm(data) {
      $('username').value = data.username || '';
      $('first_name').value = data.first_name || '';
      $('last_name').value = data.last_name || '';
      $('email').value = data.email || '';
      $('phone_number').value = data.phone_number || '';
    }

    async function preload() {
      setStatus('muted', 'Loading profile...');
      try {
        const res = await fetch(`${API_BASE}/user/profile`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        const text = await res.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch {}
        if (!res.ok) {
          setStatus('error', `Failed to load profile (${res.status})`, text);
          return;
        }
        const data = json?.data || json || {};
        fillForm(data);
        setStatus('muted', '');
      } catch (err) {
        setStatus('error', 'Failed to load profile', err.message);
      }
    }

    async function updateUser(values) {
      const methods = ['PUT', 'POST'];
      for (let method of methods) {
        try {
          const res = await fetch(`${API_BASE}/user/update`, {
            method,
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(values)
          });
          const text = await res.text();
          let json = null;
          try { json = text ? JSON.parse(text) : null; } catch {}
          if (res.ok) return { ok: true, data: json || text, method };
          if ([404, 405].includes(res.status)) continue;
          return { ok: false, error: `HTTP ${res.status}`, detail: text };
        } catch (e) {
          if (method === 'PUT') continue;
          return { ok: false, error: e.message };
        }
      }
      return { ok: false, error: 'Both PUT and POST failed' };
    }
    $('phone_number').addEventListener('input', (e) => {
      const cleaned = sanitizePhone(e.target.value);
      if (e.target.value !== cleaned) e.target.value = cleaned;
    });

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!formEl.reportValidity()) {
        return;
      }

      setStatus('muted', 'Saving...');
      const values = {
        username: $('username').value.trim(),
        first_name: $('first_name').value.trim(),
        last_name: $('last_name').value.trim(),
        email: $('email').value.trim(),
        phone_number: sanitizePhone($('phone_number').value)
      };

      const errs = validate(values);
      if (errs.length) {
        setStatus('error', 'Invalid input:\n' + errs.join('\n'));
        return;
      }

      const result = await updateUser(values);
      if (result.ok) {
        setStatus('ok', 'Saved successfully');
        const ret = qs('return');
        setTimeout(() => {
          location.href = ret || 'profile.html';
        }, 700);
      } else {
        setStatus('error', 'Save failed: ' + (result.error || 'Unknown'), result.detail);
      }
    });

    cancelBtn.addEventListener('click', () => {
      const ret = qs('return');
      if (ret) window.location.href = ret;
      else history.back();
    });

    preload();
  </script>
</body>
</html>
