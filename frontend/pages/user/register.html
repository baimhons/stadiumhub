<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign up - Football Field Booking</title>
  <link rel="stylesheet" href="../../style/register.css">
</head>
<body>
  <main>
    <section class="card" role="region" aria-labelledby="title">
      <h1 id="title">Create your account</h1>

      <form id="registerForm" novalidate>
        <label for="regUsername">Username
          <div class="fld">
            <input type="text" id="regUsername" name="username" minlength="3" required
                   autocomplete="username" placeholder="Jamelnwza007"
                   pattern="[A-Za-z0-9]{3,20}"
                   title="Letters and numbers only (3-20 characters)" />
          </div>
        </label>

        <div class="row">
          <label for="regFirstName">First name
            <div class="fld">
              <input type="text" id="regFirstName" name="first_name" required
                     autocomplete="given-name" placeholder="John"
                     pattern="[A-Za-z]{2,50}"
                     title="Letters only (2–50 characters)" />
            </div>
          </label>

          <label for="regLastName">Last name
            <div class="fld">
              <input type="text" id="regLastName" name="last_name" required
                     autocomplete="family-name" placeholder="Doe"
                     pattern="[A-Za-z]{2,50}"
                     title="Letters only (2–50 characters)" />
            </div>
          </label>
        </div>

        <label for="regEmail">Email
          <div class="fld">
            <input type="email" id="regEmail" name="email" required
                   autocomplete="email" placeholder="you1234@example.com"
                   title="Enter a valid email address" />
          </div>
        </label>

        <label for="regPhone">Phone number
          <div class="fld">
            <input type="tel" id="regPhone" name="phone_number" required
                   pattern="[0-9]{9,15}" inputmode="numeric" autocomplete="tel"
                   placeholder="0123456789"
                   title="Digits only (9-15 numbers)" />
            <small class="muted">Numbers only, 9-15 digits</small>
          </div>
        </label>

        <div class="row">
          <label for="regPassword">Password
            <div class="fld dual">
              <input type="password" id="regPassword" name="password" minlength="8" required
                     autocomplete="new-password" placeholder="at least 8 characters"
                     pattern="^[A-Za-z][0-9].{8,}$"
                     title="At least 8 characters" />
              <button class="toggle" type="button" data-toggle="regPassword" aria-controls="regPassword" aria-pressed="false" title="Show/Hide password">Show</button>
            </div>
          </label>

          <label for="regConfirm">Confirm password
            <div class="fld dual">
              <input type="password" id="regConfirm" name="confirm_password" minlength="8" required
                     autocomplete="new-password" placeholder="type it again"
                     pattern="^[A-Za-z][0-9].{8,}$"
                     title="At least 8 characters" />
              <button class="toggle" type="button" data-toggle="regConfirm" aria-controls="regConfirm" aria-pressed="false" title="Show/Hide password">Show</button>
            </div>
          </label>
        </div>

        <div class="toolbar">
          <button class="btn" id="registerBtn" type="submit">Sign up</button>
        </div>
      </form>

      <div id="console" class="console" aria-live="polite" aria-atomic="true"></div>
      <p class="foot">
        Already have an account? <a class="link" href="login.html">Log in</a> ·
        <a class="link" href="../index.html">Home</a>
      </p>
    </section>
  </main>

  <script>
    const BASE_URL = 'https://stadiumhub.onrender.com/api/v1';

    const $ = (sel) => document.querySelector(sel);
    const consoleBox = $('#console');
    const form = $('#registerForm');
    const btn = $('#registerBtn');

    const fields = {
      username:    $('#regUsername'),
      first_name:  $('#regFirstName'),
      last_name:   $('#regLastName'),
      email:       $('#regEmail'),
      phone_number:$('#regPhone'),
      password:    $('#regPassword'),
      confirm_password: $('#regConfirm'),
    };

    function logOK(msg, data){
      if(!consoleBox) return; 
      consoleBox.innerHTML =
        `<div class="msg ok">${msg}</div>` +
        (data ? `\n${escapeHtml(JSON.stringify(data, null, 2))}` : '');
      consoleBox.classList.remove('error');
      consoleBox.classList.add('ok');
    }
    function logErr(msg, data){
      if(!consoleBox) return;
      consoleBox.innerHTML =
        `<div class="msg err">${msg}</div>` +
        (data ? `\n${escapeHtml(JSON.stringify(data, null, 2))}` : '');
      consoleBox.classList.remove('ok');
      consoleBox.classList.add('error');
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    document.querySelectorAll('.toggle').forEach(tg=>{
      tg.addEventListener('click', ()=>{
        const id = tg.dataset.toggle;
        const inp = document.getElementById(id);
        const type = inp.getAttribute('type') === 'password' ? 'text' : 'password';
        inp.setAttribute('type', type);
        const show = (type !== 'password');
        tg.textContent = show ? 'Hide' : 'Show';
        tg.setAttribute('aria-pressed', String(show));
        inp.focus();
      });
    });

    fields.confirm_password.addEventListener('input', syncPwdValidity);
    fields.password.addEventListener('input', syncPwdValidity);
    function syncPwdValidity(){
      const same = fields.password.value === fields.confirm_password.value;
      fields.confirm_password.setCustomValidity(same ? '' : "Passwords don't match");
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      if(!form.checkValidity()){
        form.reportValidity();
        return;
      }

      ['username','first_name','last_name','email','phone_number'].forEach(k=>{
        fields[k].value = fields[k].value.trim();
      });

      if(fields.password.value !== fields.confirm_password.value){
        logErr('Password and confirm password are different');
        fields.confirm_password.focus();
        return;
      }

      const payload = {
        username: fields.username.value,
        first_name: fields.first_name.value,
        last_name: fields.last_name.value,
        email: fields.email.value,
        password: fields.password.value,
        confirm_password: fields.confirm_password.value,
        phone_number: fields.phone_number.value,
      };

      for (const [k,v] of Object.entries(payload)){
        if(v === '' || v == null){
          logErr(`Field "${k}" cannot be empty`);
          return;
        }
      }

      btn.disabled = true;
      btn.setAttribute('aria-busy','true');
      logOK('Signing you up...');

      try{
        const resp = await fetch(`${BASE_URL}/user/register`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload),
        });

        let data = null;
        const txt = await resp.text();
        try{ data = JSON.parse(txt); } catch{ data = { raw: txt }; }

        if(resp.ok){
          logOK('Sign up successful!');
          alert("You're all set! Redirecting to the login page...");
          location.href = 'login.html';
          return;
        }

        const msg = (data && (data.message || data.error || data.detail)) ||
                    `Sign up failed (HTTP ${resp.status})`;
        logErr(msg, data);

      }catch(err){
        logErr('Network error: ' + err.message);
      }finally{
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
      }
    });
  </script>
</body>
</html>
