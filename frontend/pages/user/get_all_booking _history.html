<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking History</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../../style/get_all_booking _history.css" />
</head>

<body>
  <div class="container">
    <header>
      <div class="title">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" stroke="#9aa4b2" stroke-width="1.2"/>
          <path d="M7 9h10M7 13h10M7 17h6" stroke="#9aa4b2" stroke-width="1.2" stroke-linecap="round"/>
        </svg>
        <h1>Booking History</h1>
      </div>
      <button class="back-btn" onclick="history.back()">Back</button>
    </header>

    <div id="state"></div>
    <section id="list" class="grid" aria-live="polite"></section>
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- ===== Modal ===== -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle" aria-hidden="true">
    <div class="sheet">
      <header>
        <h2 id="detailTitle">Order details</h2>
        <button class="close-x" aria-label="Close dialog" id="closeModalBtn">×</button>
      </header>
      <div class="content" id="detailContent"></div>
    </div>
  </div>

  <script>
    const API_BASE = "https://stadiumhub.onrender.com/api/v1";
    const PAGE_SIZE = 10;
    let currentPage = 1;
    let isLoading = false;

    const el = {
      list: document.getElementById('list'),
      state: document.getElementById('state'),
      pagination: document.getElementById('pagination'),
      modal: document.getElementById('detailModal'),
      detail: document.getElementById('detailContent'),
      closeBtn: document.getElementById('closeModalBtn')
    };

    function formatTHB(n){
      return n==null ? "-" : new Intl.NumberFormat('en-TH',{
        style:'currency',currency:'THB',maximumFractionDigits:0
      }).format(n);
    }
    function toLocalDate(iso){
      try{
        return new Date(iso).toLocaleString('en-GB',{
          timeZone:'Asia/Bangkok', year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
        });
      }catch(e){ return iso; }
    }

    // --- normalize list payload ---
    function normalizeBookings(p){
      const root = p?.data ?? p;
      if (Array.isArray(root)) return root;
      if (Array.isArray(root?.data)) return root.data;
      if (Array.isArray(root?.items)) return root.items;
      if (Array.isArray(root?.results)) return root.results;
      return [];
    }

    // --- robust pagination meta (handles both 0/1-based and missing meta) ---
    function extractPaginationMeta(p, page, pageSize, gotCount){
      const m = p?.meta || p?.pagination || p?.data?.meta || p?.data?.pagination || {};
      const nextToken = (m.next ?? m.hasNext ?? m.has_next ?? m.next_page ?? m.nextPage);

      const curPageRaw = Number(m.page ?? m.current_page ?? m.page_index);
      const size = Number(m.page_size ?? m.per_page ?? m.limit ?? pageSize) || pageSize;
      const totalPages = Number(m.total_pages ?? m.totalPages);
      const total = Number(m.total ?? m.count);

      let hasNext;

      if (typeof nextToken === 'boolean') {
        hasNext = nextToken;
      } else if (typeof nextToken === 'number') {
        hasNext = !Number.isNaN(nextToken);
      }

      if (hasNext === undefined && !Number.isNaN(totalPages)) {
        if (!Number.isNaN(curPageRaw)) {
          // covers both 0-based and 1-based cases
          hasNext = (curPageRaw + 1 < totalPages) || (curPageRaw < totalPages);
        } else {
          hasNext = page < totalPages; // UI uses 1-based
        }
      }

      if (hasNext === undefined && !Number.isNaN(total)) {
        if (!Number.isNaN(curPageRaw)) {
          hasNext = (curPageRaw * size < total) || ((curPageRaw - 1) * size < total);
        } else {
          hasNext = (page * size < total);
        }
      }

      if (hasNext === undefined) {
        hasNext = gotCount >= size; // fallback: if full page, assume next exists
      }

      return { hasNext: !!hasNext, size };
    }

    function renderState(k,m){ el.state.innerHTML=`<div class="${k}">${m}</div>`; }
    function clearState(){ el.state.innerHTML=''; }

    function renderPagination(page, hasNext) {
      el.pagination.innerHTML = '';

      const prevBtn = document.createElement('button');
      prevBtn.textContent = 'Previous';
      prevBtn.className = 'btn';
      prevBtn.disabled = page === 1 || isLoading;
      prevBtn.onclick = async () => {
        if (!isLoading && page > 1) await loadPage(page - 1);
      };

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Next';
      nextBtn.className = 'btn';
      nextBtn.disabled = !hasNext || isLoading;
      nextBtn.onclick = async () => {
        if (!isLoading && hasNext) await loadPage(page + 1); 
      };

      const pageLabel = document.createElement('span');
      pageLabel.textContent = `Page ${page}`;
      pageLabel.style.padding = '8px 12px';

      el.pagination.append(prevBtn, pageLabel, nextBtn);
    }

    async function loadPage(page){
      if (isLoading) return;
      isLoading = true;

      renderState('loading', `Loading page ${page}...`);
      el.list.innerHTML='';

      try{
        const res = await fetch(`${API_BASE}/booking/history?page=${page}&page_size=${PAGE_SIZE}&sort=created_at&order=desc`, {
          method:'GET', credentials:'include', headers:{'Accept':'application/json'}
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);

        const payload = await res.json();
        const bookings = normalizeBookings(payload);
        window._lastBookings = bookings;

        clearState();
        renderList(bookings);

        const { hasNext } = extractPaginationMeta(payload, page, PAGE_SIZE, bookings.length);
        currentPage = page;
        renderPagination(currentPage, hasNext);

        window.scrollTo({ top: 0, behavior: 'instant' });
      } catch(err) {
        console.error(err);
        renderState('error', `Failed to load: ${err.message}`);
        renderPagination(currentPage, true);
      } finally {
        isLoading = false;
      }
    }

    function getBookingId(b){
      return b?.id ?? b?.booking_id ?? b?.order_id ?? b?.uuid ?? b?.reference_id ?? null;
    }

    function renderList(bookings){
      if(!bookings.length){
        el.list.innerHTML='';
        renderState('empty','No booking history yet');
        return;
      }
      clearState();

      const html = bookings.map(b=>{
        const m=b.Match||{};
        const home=m.HomeTeam?.ShortName||'-', away=m.AwayTeam?.ShortName||'-';
        const venue=m.Venue||m.HomeTeam?.Venue||'-';
        const status=b.status||'UNKNOWN', total=b.total_price;

        const tickets = b?.tickets ?? b?.Seats ?? b?.seats ?? b?.items ?? [];
        const firstSeat = Array.isArray(tickets) ? tickets[0] : null;
        const seatChip = firstSeat ? seatSummaryFromAny(firstSeat) : '';

        const id=getBookingId(b);
        return `
          <article class="card" data-id="${id ?? ''}" tabindex="0" role="button" aria-label="Open order details">
            <div class="row">
              <h3>${home} <span class="muted">vs</span> ${away}</h3>
              <span class="status ${status}">${status}</span>
            </div>
            <div class="muted small">${venue}</div>
            <footer>
              ${seatChip ? `<span class="pill">${seatChip}</span>` : ''}
              <span class="total">${formatTHB(total)}</span>
            </footer>
          </article>`;
      }).join('');

      el.list.innerHTML = html;

      el.list.querySelectorAll('.card').forEach(card=>{
        card.addEventListener('click', onCardActivate);
        card.addEventListener('keydown', e=>{
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onCardActivate.call(card, e); }
        });
      });
    }

    // --- seats helpers ---
    function getSeatParts(obj = {}) {
      const o = obj.Seat || obj.seat || obj;
      const zone = o?.block ?? o?.Block ?? o?.zone ?? o?.Zone ?? o?.section ?? o?.section_name ?? o?.sectionName ?? o?.area ?? o?.stand ?? null;
      const row  = o?.row ?? o?.Row ?? o?.line ?? o?.Line ?? o?.row_number ?? o?.rowNumber ?? o?.RowNumber ?? o?.tier ?? null;
      const seat = o?.seat ?? o?.Seat ?? o?.number ?? o?.No ?? o?.no ?? o?.seat_no ?? o?.seatNo ?? o?.SeatNumber ?? o?.seat_number ?? o?.label ?? o?.seat_label ?? null;
      return { zone, row, seat };
    }
    function seatSummaryFromAny(item) {
      const { zone, row, seat } = getSeatParts(item || {});
      const parts = [];
      if (seat) parts.push(`Seat ${seat}`);
      if (row) parts.push(`Row ${row}`);
      if (zone) parts.push(`Zone ${zone}`);
      return parts.join(" · ");
    }

    async function onCardActivate(e){
      const id = this.getAttribute('data-id');
      const idx = Array.from(el.list.children).indexOf(this);
      const fallbackBooking = window._lastBookings?.[idx] ?? null;

      openModal(loadingDetailSkeleton());

      if (id) {
        try {
          const res = await fetch(`${API_BASE}/booking/${encodeURIComponent(id)}`, {
            method:'GET', credentials:'include', headers:{'Accept':'application/json'}
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          const detail = payload?.data ?? payload;
          el.detail.innerHTML = renderDetailContent(detail);
          return;
        } catch(err) {
          console.warn('detail api failed, fallback to list item', err);
        }
      }

      if (fallbackBooking) {
        el.detail.innerHTML = renderDetailContent(fallbackBooking, true);
      } else {
        el.detail.innerHTML = `<div class="error">Unable to load details</div>`;
      }
    }

    function loadingDetailSkeleton(){
      return `
        <div class="kv">
          <div class="k">Status</div><div>Loading...</div>
          <div class="k">Order ID</div><div>Loading...</div>
          <div class="k">Total</div><div>Loading...</div>
        </div>
        <div class="divider"></div>
        <div class="muted small">Fetching seat/ticket details...</div>
      `;
    }

    function renderDetailContent(b, isFallback=false){
      const id = getBookingId(b) || '—';
      const status = b?.status ?? 'UNKNOWN';
      const created = b?.created_at || b?.createdAt || b?.created || b?.ordered_at || null;
      const total = b?.total_price ?? b?.amount ?? b?.total ?? null;

      const tickets = b?.tickets ?? b?.Seats ?? b?.seats ?? b?.items ?? [];
      const match = b?.Match ?? b?.match ?? {};
      const home = match?.HomeTeam?.ShortName ?? match?.home ?? '-';
      const away = match?.AwayTeam?.ShortName ?? match?.away ?? '-';
      const venue = match?.Venue ?? match?.HomeTeam?.Venue ?? b?.venue ?? '-';

      const customer = b?.customer ?? b?.User ?? b?.user ?? {};
      const name = customer?.name ?? customer?.full_name ?? customer?.FullName ?? '';
      const email = customer?.email ?? '';

      const metaBlock = `
        <div class="kv" style="margin-bottom:8px">
          <div class="k">Order ID</div><div><span class="tag">${id}</span></div>
          <div class="k">Status</div><div><span class="status ${status}">${status}</span></div>
          <div class="k">Total</div><div class="total">${formatTHB(total)}</div>
          <div class="k">Created</div><div>${created ? toLocalDate(created) : '-'}</div>
        </div>
      `;

      const matchBlock = `
        <div class="kv" style="margin:10px 0 8px">
          <div class="k">Match</div><div>${home} <span class="muted">vs</span> ${away}</div>
          <div class="k">Venue</div><div>${venue}</div>
        </div>
      `;

      const customerBlock = (name || email) ? `
        <div class="kv" style="margin:10px 0 8px">
          <div class="k">Customer</div><div>${name || '-'}</div>
          <div class="k">Email</div><div>${email || '-'}</div>
        </div>
      ` : '';

      const ticketList = Array.isArray(tickets) && tickets.length
        ? `
          <div class="divider"></div>
          <div style="margin-bottom:6px; font-weight:600">Tickets / Seats</div>
          <div class="grid" style="gap:8px">
            ${tickets.map((t)=>{
              const { zone, row, seat } = getSeatParts(t);
              const price = t?.price ?? t?.amount ?? t?.Price ?? null;
              const ref = t?.ticket_id ?? t?.id ?? t?.uuid ?? t?.reference ?? '';
              const line = [
                seat ? `Seat ${seat}` : null,
                row ? `<span class="muted">Row</span> ${row}` : null,
                zone ? `<span class="muted">Zone</span> ${zone}` : null
              ].filter(Boolean).join(' ');

              return `
                <div style="border:1px solid var(--border); border-radius:12px; padding:10px 12px">
                  <div style="display:flex; justify-content:space-between; align-items:center">
                    <div>${line || '-'}</div>
                    <div>${formatTHB(price)}</div>
                  </div>
                  ${ref ? `<div class="muted small" style="margin-top:4px">Ticket ID: ${ref}</div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        ` : '';

      const fallbackNote = isFallback
        ? `<div class="muted small" style="margin-top:10px">Displayed using basic list data (could not fetch detailed info from API)</div>`
        : '';

      return metaBlock + matchBlock + customerBlock + ticketList + fallbackNote ;
    }

    // ===== Modal helpers =====
    function openModal(innerHtml){
      el.detail.innerHTML = innerHtml || '';
      el.modal.classList.add('open');
      el.modal.removeAttribute('aria-hidden');
      setTimeout(()=> el.closeBtn.focus(), 0);
      el.modal.addEventListener('click', onBackdropClick);
      window.addEventListener('keydown', onEsc);
    }
    function closeModal(){
      el.modal.classList.remove('open');
      el.modal.setAttribute('aria-hidden','true');
      el.detail.innerHTML = '';
      el.modal.removeEventListener('click', onBackdropClick);
      window.removeEventListener('keydown', onEsc);
    }
    function onBackdropClick(e){ if (e.target === el.modal) closeModal(); }
    function onEsc(e){ if (e.key === 'Escape') closeModal(); }

    el.closeBtn.addEventListener('click', closeModal);
    window.addEventListener('DOMContentLoaded', () => loadPage(1));
  </script>
</body>
</html>
