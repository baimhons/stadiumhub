<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö - ‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      width: 100%;
      max-width: 440px;
    }
    h2 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }
    label {
      display: block;
      margin-bottom: 20px;
      color: #555;
      font-weight: 500;
    }
    input {
      width: 100%;
      padding: 12px 16px;
      margin-top: 8px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.3s;
      margin-top: 10px;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .muted {
      text-align: center;
      margin-top: 25px;
      color: #666;
      font-size: 14px;
      line-height: 1.8;
    }
    .muted a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }
    .muted a:hover {
      text-decoration: underline;
    }
    .console {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 300px;
      overflow-y: auto;
    }
    .error {
      color: #ff4444 !important;
    }
    .success {
      color: #00ff00 !important;
    }
    .env-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="env-badge" id="envBadge">üîß Loading...</div>
  
  <div class="card">
    <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>

    <form id="loginForm" novalidate>
      <label for="loginEmail">
        ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        <input
          type="text"
          id="loginEmail"
          name="username_or_email"
          placeholder="adminStadiumHub"
          autocomplete="username"
          required
        />
      </label>

      <label for="loginPassword">
        ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        <input
          type="password"
          id="loginPassword"
          name="password"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          minlength="6"
          autocomplete="current-password"
          required
        />
      </label>

      <button class="btn" id="submitBtn" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>

      <p class="muted">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="register.html">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a><br />
        <a href="../pages/index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      </p>
    </form>

    <pre id="result" class="console">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</pre>
  </div>

  <script>
    const form = document.getElementById('loginForm');
    const result = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');
    const envBadge = document.getElementById('envBadge');

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö environment ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á API_BASE ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    const isLocalhost = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
    
    const API_BASE = isLocalhost 
      ? 'http://localhost:8080/api/v1'  // Development
      : 'https://stadiumhub.onrender.com/api/v1';  // Production

    // ‡πÅ‡∏™‡∏î‡∏á environment badge
    envBadge.textContent = isLocalhost ? 'üîß Development' : 'üöÄ Production';

    // ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Token ‡πÅ‡∏ö‡∏ö in-memory (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ localStorage)
    let sessionToken = null;

    function saveToken(token) {
      sessionToken = token;
      console.log('‚úÖ Token saved in memory');
    }

    function getToken() {
      return sessionToken;
    }

    function clearToken() {
      sessionToken = null;
    }

    function log(message, isError = false) {
      result.className = isError ? 'console error' : 'console';
      result.textContent = message;
      console.log(message);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      submitBtn.disabled = true;
      log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...\nAPI: ' + API_BASE);

      const payload = {
        username_or_email: document.getElementById('loginEmail').value.trim(),
        password: document.getElementById('loginPassword').value,
      };

      try {
        // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: Login
        log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
        const loginResp = await fetch(`${API_BASE}/user/login`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload),
          credentials: 'include',
        });

        const loginData = await loginResp.json();
        console.log('LOGIN Response:', {
          status: loginResp.status,
          headers: Object.fromEntries(loginResp.headers.entries()),
          data: loginData
        });

        if (!loginResp.ok) {
          throw new Error(loginData.message || `Login failed: ${loginResp.status}`);
        }

        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å token (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å response body)
        let token = null;
        if (loginData.data?.session_id) {
          token = loginData.data.session_id;
        } else if (loginData.data?.token) {
          token = loginData.data.token;
        }

        if (token) {
          saveToken(token);
          log(`‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\nToken: ${token.substring(0, 30)}...\nMode: ${isLocalhost ? 'Cookie' : 'Token-based'}`);
        } else {
          log('‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Cookie-based)');
        }

        // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile
        await new Promise(resolve => setTimeout(resolve, 500));
        
        log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...');
        
        const headers = {
          'Accept': 'application/json'
        };
        
        // ‚úÖ ‡∏™‡πà‡∏á token ‡πÉ‡∏ô Authorization header (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ô production)
        // reuse token variable declared earlier to avoid redeclaration error
        token = getToken();
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
          console.log('üì§ Sending Authorization:', headers['Authorization'].substring(0, 40) + '...');
        } else if (!isLocalhost) {
          throw new Error('No token available for production mode');
        }

        const profileResp = await fetch(`${API_BASE}/user/profile`, {
          method: 'GET',
          headers: headers,
          credentials: 'include'
        });

        const profileData = await profileResp.json();
        console.log('PROFILE Response:', {
          status: profileResp.status,
          headers: Object.fromEntries(profileResp.headers.entries()),
          data: profileData
        });

        if (!profileResp.ok) {
          throw new Error(profileData.message || `Profile fetch failed: ${profileResp.status}`);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const userInfo = JSON.stringify(profileData, null, 2);
        log(`‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:\n${userInfo}`);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö role ‡πÅ‡∏•‡∏∞ redirect
        if (profileData?.data) {
          const user = profileData.data;
          
          setTimeout(() => {
            const isAdmin = user.role === 'admin' || user.is_admin === true;
            const targetPage = isAdmin ? '../admin/admin.html' : '../match/match.html';
            
            log(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ ${isAdmin ? 'Admin' : 'Match'}...`, false);
            
            // Redirect
            window.location.href = targetPage;
          }, 1500);
        } else {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô response');
        }

      } catch (err) {
        console.error('‚ùå Error:', err);
        clearToken();
        
        let errorMsg = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${err.message}\n\n`;
        
        if (err.message.includes('Failed to fetch')) {
          errorMsg += 'üîç ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend:\n';
          errorMsg += `- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Backend ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\n`;
          errorMsg += `- URL: ${API_BASE}\n`;
          errorMsg += `- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CORS configuration`;
        } else if (err.message.includes('401') || err.message.includes('session')) {
          errorMsg += 'üîç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Authentication:\n';
          errorMsg += `- Username/Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n`;
          errorMsg += `- ‡∏´‡∏£‡∏∑‡∏≠ Session/Cookie ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô\n`;
          errorMsg += `- ENV: ${isLocalhost ? 'Local (Cookie ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)' : 'Production (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Token!)'}`;
        } else {
          errorMsg += 'üîç ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
        }
        
        log(errorMsg, true);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤ default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    if (isLocalhost) {
      document.getElementById('loginEmail').value = 'adminStadiumHub';
      log('üîß Development Mode\nAPI: ' + API_BASE + '\n\n‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Cookie-based)');
    } else {
      log('üöÄ Production Mode\nAPI: ' + API_BASE + '\n\n‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Token-based)');
    }
  </script>
</body>
</html>